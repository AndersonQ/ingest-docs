<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<meta name="description" content="Learn configuration options for Elastic Serverless Forwarder and how to transform your AWS data as it is collected from Amazon Web Services (AWS).">
<meta name="keywords" content="serverless">
<title>Elastic Serverless Forwarder for AWS | Observability Guide | Elastic</title>
<meta class="elastic" name="content" content="Elastic Serverless Forwarder for AWS | Observability Guide">

<link rel="home" href="index.html" title="Observability Guide"/>
<link rel="up" href="add-observability-data.html" title="Send data to Elasticsearch"/>
<link rel="prev" href="deploy-beats-to-send-data.html" title="Deploy Beats to send data"/>
<link rel="next" href="aws-firehose.html" title="Amazon Kinesis Data Firehose"/>
<meta class="elastic" name="product_version" content=""/>
<meta class="elastic" name="product_name" content=""/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <!--BEGIN QUALTRICS WEBSITE FEEDBACK SNIPPET-->
    <script type='text/javascript'>
      (function(){var g=function(e,h,f,g){
      this.get=function(a){for(var a=a+"=",c=document.cookie.split(";"),b=0,e=c.length;b<e;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null};
      this.set=function(a,c){var b="",b=new Date;b.setTime(b.getTime()+6048E5);b="; expires="+b.toGMTString();document.cookie=a+"="+c+b+"; path=/; "};
      this.check=function(){var a=this.get(f);if(a)a=a.split(":");else if(100!=e)"v"==h&&(e=Math.random()>=e/100?0:100),a=[h,e,0],this.set(f,a.join(":"));else return!0;var c=a[1];if(100==c)return!0;switch(a[0]){case "v":return!1;case "r":return c=a[2]%Math.floor(100/c),a[2]++,this.set(f,a.join(":")),!c}return!0};
      this.go=function(){if(this.check()){var a=document.createElement("script");a.type="text/javascript";a.src=g;document.body&&document.body.appendChild(a)}};
      this.start=function(){var a=this;window.addEventListener?window.addEventListener("load",function(){a.go()},!1):window.attachEvent&&window.attachEvent("onload",function(){a.go()})}};
      try{(new g(100,"r","QSI_S_ZN_emkP0oSe9Qrn7kF","https://znemkp0ose9qrn7kf-elastic.siteintercept.qualtrics.com/WRSiteInterceptEngine/?Q_ZID=ZN_emkP0oSe9Qrn7kF")).start()}catch(i){}})();
    </script><div id='ZN_emkP0oSe9Qrn7kF'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
    <!--END WEBSITE FEEDBACK SNIPPET-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Observability Guide</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="add-observability-data.html">Send data to Elasticsearch</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="deploy-beats-to-send-data.html">« Deploy Beats to send data</a>
</span>
<span class="next">
<a href="aws-firehose.html">Amazon Kinesis Data Firehose »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="aws-elastic-serverless-forwarder"></a>Elastic Serverless Forwarder for AWS<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder.asciidoc">edit</a></h2>
</div></div></div>

<p>The Elastic Serverless Forwarder is an Amazon Web Services (AWS) Lambda function that ships logs from your AWS environment to Elastic.</p>
<p>The Elastic Serverless Forwarder works with Elastic Stack 7.16 and later.</p>
<h3><a id="aws-serverless-forwarder-overview"></a>Overview<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder.asciidoc">edit</a></h3>
<p>The Elastic Serverless Forwarder can forward AWS data to cloud-hosted, self-managed Elastic environments, or <span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will apply best effort to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span>Logstash. It supports the following inputs:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Amazon S3 (via SQS event notifications)
</li>
<li class="listitem">
Amazon Kinesis Data Streams
</li>
<li class="listitem">
Amazon CloudWatch Logs subscription filters
</li>
<li class="listitem">
Amazon SQS message payload
</li>
</ul>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/aws-serverless-lambda-flow.png" alt="AWS Lambda flow">
</div>
</div>
<p>When you successfully deploy the forwarder, an SQS <em>Continuing queue</em> is automatically created in Lambda to ensure no data is lost. By default the forwarder runs for a maximum of 15 minutes so it&#8217;s possible that AWS may exit the function in the middle of processing event data. The forwarder handles this scenario by keeping track of the last offset processed. When the queue triggers a new function invocation, the forwarder will start where the last function run stopped.</p>
<p>The forwarder uses a <em>Replay queue</em> (also automatically created during deployment) to handle any ingestion-related exception or fail scenarios. Data in the replay queue is stored as individual events. Lambda keeps track of any failed events and writes them to a replay queue that can then be consumed by adding an additional SQS trigger via Lambda.</p>
<p>You can use the <a class="xref" href="aws-elastic-serverless-forwarder.html#sample-s3-config-file" title="Create and upload config.yaml to S3 bucket">config.yaml</a> file to configure the service for each input and output type, including information such as SQS queue ARN (Amazon Resource Number) and Elasticsearch or Logstash connection details. You can create multiple input sections within the configuration file to map different inputs to specific log types.</p>
<p>The forwarder also supports writing directly to an index, alias, or custom data stream. This enables existing Elasticsearch users to re-use index templates, ingest pipelines, or dashboards that are already created and connected to other processes.</p>
<h3><a id="aws-serverless-forwarder-inputs"></a>Inputs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder.asciidoc">edit</a></h3>
<h4><a id="aws-serverless-forwarder-inputs-s3"></a>Amazon S3 (via SQS event notifications)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder.asciidoc">edit</a></h4>
<p>The forwarder can ingest logs contained in an Amazon Simple Storage Service (S3) bucket through a Simple Queue Service (SQS) notification (<code class="literal">s3:ObjectCreated</code>) and send them to Elastic. The SQS queue serves as a trigger for the forwarder. When a new log file is written to an S3 bucket and meets the user-defined criteria (including prefix/suffix), an SQS notification is generated that triggers the Lambda function.</p>
<p>You can set up separate SQS queues for each type of log (for example, <code class="literal">aws.vpcflow</code>, <code class="literal">aws.cloudtrail</code>, <code class="literal">aws.waf</code>). A single configuration file can have many input sections, pointing to different SQS queues that match specific log types. The <code class="literal">es_datastream_name</code> parameter in the config file is optional. The forwarder supports automatic routing of various AWS service logs to the corresponding data streams for further processing and storage in the Elasticsearch cluster. It supports automatic routing of <code class="literal">aws.cloudtrail</code>, <code class="literal">aws.cloudwatch_logs</code>, <code class="literal">aws.elb_logs</code>, <code class="literal">aws.firewall_logs</code>, <code class="literal">aws.vpcflow</code>, and <code class="literal">aws.waf</code> logs.</p>
<p>For other log types, you can optionally set the <code class="literal">es_datastream_name</code> value in the configuration file according to the naming convention of the Elasticsearch data stream and integration.  If the <code class="literal">es_datastream_name</code> is not specified, and the log cannot be matched with any of the above AWS services, then the dataset will be set to <code class="literal">generic</code> and the namespace set to <code class="literal">default</code>, pointing to the data stream name <code class="literal">logs-generic-default</code>.</p>
<p>For more information on creating SQS event notifications for S3 buckets, read the <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/ways-to-add-notification-config-to-bucket.html" class="ulink" target="_top">AWS documentation</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You must set a visibility timeout of <code class="literal">910</code> seconds for any SQS queues you want to use as a trigger. This is 10 seconds greater than the Elastic Serverless Forwarder Lambda timeout.</p>
</div>
</div>
<h4><a id="aws-serverless-forwarder-inputs-kinesis"></a>Amazon Kinesis Data Streams<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder.asciidoc">edit</a></h4>
<p>The forwarder can ingest logs contained in the payload of a Kinesis Data Stream record and send them to Elastic. The Kinesis Data Stream serves as a trigger for the forwarder. When a new record gets written to a Kinesis Data Stream, it triggers the Lambda function.</p>
<p>You can set up separate Kinesis Data Streams for each type of log. The <code class="literal">es_datastream_name</code> parameter in the config file is mandatory. If this value is set to an Elasticsearch data stream, the type of log must be correctly defined with configuration parameters. A single configuration file can have many input sections, pointing to different data streams that match specific log types.</p>
<h4><a id="aws-serverless-forwarder-inputs-cloudwatch"></a>Amazon CloudWatch Logs subscription filters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder.asciidoc">edit</a></h4>
<p>The forwarder can ingest logs contained in the message payload of CloudWatch Logs events and send them to Elastic. The CloudWatch Logs service serves as a trigger for the forwarder. When a new event gets written to a CloudWatch Logs log stream, it triggers the Lambda function.</p>
<p>You can set up separate CloudWatch Logs groups for each type of log. The <code class="literal">es_datastream_name</code> parameter in the config file is mandatory. If this value is set to an Elasticsearch data stream, the type of log must be correctly defined with configuration parameters. A single configuration file can have many input sections, pointing to different CloudWatch Logs groups that match specific log types.</p>
<h4><a id="aws-serverless-forwarder-inputs-direct"></a>Amazon SQS message payload<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder.asciidoc">edit</a></h4>
<p>The forwarder can ingest logs contained within the payload of an Amazon SQS body record and send them to Elastic. The SQS queue serves as a trigger for the forwarder. When a new record gets written to an SQS queue, the Lambda function triggers.</p>
<p>You can set up a separate SQS queue for each type of log. The config parameter for Elasticsearch output <code class="literal">es_datastream_name</code> is mandatory. If this value is set to an Elasticsearch data stream, the type of log must be correctly defined with configuration parameters. A single configuration file can have many input sections, pointing to different SQS queues that match specific log types.</p>
<h3><a id="aws-serverless-forwarder-get-started"></a>Get started<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder.asciidoc">edit</a></h3>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-deploy-elastic-serverless-forwarder" title="Deploy Elastic Serverless Forwarder">Deploy Elastic Serverless Forwarder</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-elastic-serverless-forwarder-configuration" title="Configuration options for Elastic Serverless Forwarder">Configuration options</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-troubleshooting" title="Troubleshooting and error handling">Troubleshooting</a>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="aws-deploy-elastic-serverless-forwarder"></a>Deploy Elastic Serverless Forwarder<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h3>
</div></div></div>

<p>To deploy Elastic Serverless Forwarder, you have to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-deploy-kibana" title="Install AWS integration assets in Kibana">Install AWS integration assets in Kibana</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#sample-s3-config-file" title="Create and upload config.yaml to S3 bucket">Create and upload <code class="literal">config.yaml</code> to S3 bucket</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-define-deploy-parameters" title="Define deployment parameters">Define deployment parameters</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-deploy-sar" title="Deploy Elastic Serverless Forwarder from SAR">Deploy Elastic Serverless Forwarder from SAR</a>
</li>
</ul>
</div>
<h6><a id="aws-serverless-forwarder-deploy-prereq"></a>Prerequisites<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h6>
<p>This documentation assumes you have some familiarity with AWS services and you have correctly created and configured the necessary AWS objects. For example, if you want to use an Amazon S3 (via SQS event notifications) input then you must ensure that you have enabled AWS VPC flow logs to be sent to that bucket, and created an SQS queue to receive those logs. For more information, refer to the relevant <a href="https://docs.aws.amazon.com/" class="ulink" target="_top">AWS docs</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This page describes the basic steps required to deploy Elastic Serverless
Forwarder for AWS— for additional information on configuration topics such as permissions and automatic routing, and parsing and enriching data, see <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-elastic-serverless-forwarder-configuration" title="Configuration options for Elastic Serverless Forwarder">Configuration options</a>.</p>
</div>
</div>
<h5><a id="aws-serverless-forwarder-deploy-direct-note"></a>Deploying directly without SAR<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
<p>If the customization options available when deploying via Serverless Application Repository (SAR) are not sufficient, from version <code class="literal">1.6.0</code> and above you can <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-direct-deploy" title="Deploy Elastic Serverless Forwarder directly">deploy the Elastic Serverless Forwarder directly</a> to your AWS Account without using SAR. This enables you to customize the event source settings for the inputs (i.e. triggers) one-by-one.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-forwarder-deploy-kibana"></a>Install AWS integration assets in Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h4>
</div></div></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Integrations</strong></span> in Kibana and search for AWS (or select the <span class="strong strong"><strong>AWS</strong></span>
category to filter the list).
</li>
<li class="listitem">
Click the AWS integration, select <span class="strong strong"><strong>Settings</strong></span> and click
<span class="strong strong"><strong>Install AWS assets</strong></span> and confirm to install all the AWS integration assets.
</li>
</ol>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/aws-serverless-forwarder-install-assets.png" alt="Find and install AWS integration assets in Kibana">
</div>
</div>
<p>Adding integrations from Kibana provides appropriate pre-built dashboards,
ingest node configurations, and other assets that help you get the most out of
the data you ingest. The integrations use <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/data-streams.html" class="ulink" target="_top">data streams</a>
with specific <a href="https://www.elastic.co/blog/an-introduction-to-the-elastic-data-stream-naming-scheme" class="ulink" target="_top">naming conventions</a>
that provide you with more granular controls and flexibility on managing data ingestion.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>We recommend using integration assets to get started but the forwarder supports writing to any index, alias, or custom data stream. This enables existing Elasticsearch users to re-use index templates, ingest pipelines, or dashboards that are already created and connected to existing processes or systems. If you already have an existing index or data stream you intend to send data to, then you can skip this deployment step.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="sample-s3-config-file"></a>Create and upload <code class="literal">config.yaml</code> to S3 bucket<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h4>
</div></div></div>
<p>Elastic Serverless Forwarder requires a <code class="literal">config.yaml</code> file to be uploaded to an S3 bucket and referenced by the <code class="literal">S3_CONFIG_FILE</code> environment variable.</p>
<p>Save the following YAML content as <code class="literal">config.yaml</code> and edit as required before uploading to an S3 bucket. You should remove any inputs or arguments you are not using, and ensure you have entered the correct URLs and credentials as per the inline comments.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">inputs:
  - type: "s3-sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    outputs:
      - type: "elasticsearch"
        args:
          # either elasticsearch_url or cloud_id, elasticsearch_url takes precedence if both are included
          elasticsearch_url: "http(s)://domain.tld:port"
          cloud_id: "cloud_id:bG9jYWxob3N0OjkyMDAkMA=="
          # either api_key or username/password, username/password takes precedence if both are included
          api_key: "YXBpX2tleV9pZDphcGlfa2V5X3NlY3JldAo="
          username: "username"
          password: "password"
          es_datastream_name: "logs-generic-default"
          batch_max_actions: 500 # optional: default value is 500
          batch_max_bytes: 10485760 # optional: default value is 10485760
      - type: "logstash"
        args:
          logstash_url: "http(s)://host:port"
          username: "username" #optional
          password: "password" #optional
          max_batch_size: 500 #optional
          compression_level: 1 #optional
          ssl_assert_fingerprint: "22:F7:FB:84:1D:43:3E:E7:BB:F9:72:F3:D8:97:AD:7C:86:E3:08:42" #optional
  - type: "sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    outputs:
      - type: "elasticsearch"
        args:
          # either elasticsearch_url or cloud_id, elasticsearch_url takes precedence if both are included
          elasticsearch_url: "http(s)://domain.tld:port"
          cloud_id: "cloud_id:bG9jYWxob3N0OjkyMDAkMA=="
          # either api_key or username/password, username/password takes precedence if both are included
          api_key: "YXBpX2tleV9pZDphcGlfa2V5X3NlY3JldAo="
          username: "username"
          password: "password"
          es_datastream_name: "logs-generic-default"
          batch_max_actions: 500 # optional: default value is 500
          batch_max_bytes: 10485760 # optional: default value is 10485760
      - type: "logstash"
        args:
          logstash_url: "http(s)://host:port"
          username: "username" #optional
          password: "password" #optional
          max_batch_size: 500 #optional
          compression_level: 1 #optional
          ssl_assert_fingerprint: "22:F7:FB:84:1D:43:3E:E7:BB:F9:72:F3:D8:97:AD:7C:86:E3:08:42" #optional
  - type: "kinesis-data-stream"
    id: "arn:aws:kinesis:%REGION%:%ACCOUNT%:stream/%STREAMNAME%"
    outputs:
      - type: "elasticsearch"
        args:
          # either elasticsearch_url or cloud_id, elasticsearch_url takes precedence if both are included
          elasticsearch_url: "http(s)://domain.tld:port"
          cloud_id: "cloud_id:bG9jYWxob3N0OjkyMDAkMA=="
          # either api_key or username/password, username/password takes precedence if both are included
          api_key: "YXBpX2tleV9pZDphcGlfa2V5X3NlY3JldAo="
          username: "username"
          password: "password"
          es_datastream_name: "logs-generic-default"
          batch_max_actions: 500 # optional: default value is 500
          batch_max_bytes: 10485760 # optional: default value is 10485760
      - type: "logstash"
        args:
          logstash_url: "http(s)://host:port"
          username: "username" #optional
          password: "password" #optional
          max_batch_size: 500 #optional
          compression_level: 1 #optional
          ssl_assert_fingerprint: "22:F7:FB:84:1D:43:3E:E7:BB:F9:72:F3:D8:97:AD:7C:86:E3:08:42" #optional
  - type: "cloudwatch-logs"
    id: "arn:aws:logs:%AWS_REGION%:%AWS_ACCOUNT_ID%:log-group:%LOG_GROUP_NAME%:*"
    outputs:
      - type: "elasticsearch"
        args:
          # either elasticsearch_url or cloud_id, elasticsearch_url takes precedence if both are included
          elasticsearch_url: "http(s)://domain.tld:port"
          cloud_id: "cloud_id:bG9jYWxob3N0OjkyMDAkMA=="
          # either api_key or username/password, username/password takes precedence if both are included
          api_key: "YXBpX2tleV9pZDphcGlfa2V5X3NlY3JldAo="
          username: "username"
          password: "password"
          es_datastream_name: "logs-generic-default"
          batch_max_actions: 500 # optional: default value is 500
          batch_max_bytes: 10485760 # optional: default value is 10485760
      - type: "logstash"
        args:
          logstash_url: "http(s)://host:port"
          username: "username" #optional
          password: "password" #optional
          max_batch_size: 500 #optional
          compression_level: 1 #optional
          ssl_assert_fingerprint: "22:F7:FB:84:1D:43:3E:E7:BB:F9:72:F3:D8:97:AD:7C:86:E3:08:42" #optional
  - type: "cloudwatch-logs"
    id: "arn:aws:logs:%AWS_REGION%:%AWS_ACCOUNT_ID%:log-group:%LOG_GROUP_NAME%:log-stream:%LOG_STREAM_NAME%"
    outputs:
      - type: "elasticsearch"
        args:
          # either elasticsearch_url or cloud_id, elasticsearch_url takes precedence if both are included
          elasticsearch_url: "http(s)://domain.tld:port"
          cloud_id: "cloud_id:bG9jYWxob3N0OjkyMDAkMA=="
          # either api_key or username/password, username/password takes precedence if both are included
          api_key: "YXBpX2tleV9pZDphcGlfa2V5X3NlY3JldAo="
          username: "username"
          password: "password"
          es_datastream_name: "logs-generic-default"
          batch_max_actions: 500 # optional: default value is 500
          batch_max_bytes: 10485760 # optional: default value is 10485760
      - type: "logstash"
        args:
          logstash_url: "http(s)://host:port"
          username: "username" #optional
          password: "password" #optional
          max_batch_size: 500 #optional
          compression_level: 1 #optional
          ssl_assert_fingerprint: "22:F7:FB:84:1D:43:3E:E7:BB:F9:72:F3:D8:97:AD:7C:86:E3:08:42" #optional</pre>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="s3-config-file-fields"></a>Fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
</div></div></div>
<p><code class="literal">inputs.[]</code>:</p>
<p>A list of inputs (i.e. triggers) for the Elastic Serverless Forwarder Lambda function.</p>
<p><code class="literal">inputs.[].type</code>:</p>
<p>The type of trigger input (<code class="literal">cloudwatch-logs</code>, <code class="literal">kinesis-data-stream</code>, <code class="literal">sqs</code> and <code class="literal">s3-sqs</code> are currently supported).</p>
<p><code class="literal">inputs.[].id</code>:</p>
<p>The ARN of the trigger input according to the type. Multiple input entries can have different unique ids with the same type.
Inputs of type <code class="literal">cloudwatch-logs</code> accept both CloudWatch Logs Log Group and CloudWatch Logs Log Stream ARNs.</p>
<p><code class="literal">inputs.[].outputs</code>:</p>
<p>A list of outputs (i.e. forwarding targets) for the Elastic Serverless Forwarder Lambda function. You can have multiple outputs for an input, but only one output can be defined per type.</p>
<p><code class="literal">inputs.[].outputs.[].type</code>:</p>
<p>The type of the forwarding target output. Currently only the following outputs are supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">elasticsearch</code>
</li>
<li class="listitem">
<span class="Admonishment Admonishment--preview">
[<span class="Admonishment-title u-mono">preview</span>]
<span class="Admonishment-detail">
This functionality is in technical preview and may be changed or removed in a future release. Elastic will apply best effort to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.
</span>
</span> <code class="literal">logstash</code>
</li>
</ul>
</div>
<p>If Logstash is chosen as an output, Elastic Serverless Forwarder expects the <a href="https://www.elastic.co/guide/en/logstash/master/plugins-inputs-elastic_serverless_forwarder.html" class="ulink" target="_top"><code class="literal">elastic_serverless_forwarder</code></a> Logstash input to be installed, enabled, and properly configured. For more information about installing Logstash plugins, refer to the <a href="https://www.elastic.co/guide/en/logstash/master/working-with-plugins.html#installing-plugins" class="ulink" target="_top">Logstash documentation</a>.</p>
<p><code class="literal">inputs.[].outputs.[].args</code>:
Custom init arguments for the specified forwarding target output.</p>
<p>For <code class="literal">elasticsearch</code> the following arguments are supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">args.elasticsearch_url</code>: URL of elasticsearch endpoint in the format <code class="literal">http(s)://domain.tld:port</code>. Mandatory when <code class="literal">args.cloud_id</code> is not provided. Will take precedence over <code class="literal">args.cloud_id</code> if both are defined.
</li>
<li class="listitem">
<code class="literal">args.cloud_id</code>: Cloud ID of elasticsearch endpoint. Mandatory when <code class="literal">args.elasticsearch_url</code> is not provided. Will be ignored if <code class="literal">args.elasticsearch_url</code> is defined.
</li>
<li class="listitem">
<code class="literal">args.username</code>: Username of the elasticsearch instance to connect to. Mandatory when <code class="literal">args.api_key</code> is not provided. Will take precedence over <code class="literal">args.api_key</code> if both are defined.
</li>
<li class="listitem">
<code class="literal">args.password</code> Password of the elasticsearch instance to connect to. Mandatory when <code class="literal">args.api_key</code> is not provided. Will take precedence over <code class="literal">args.api_key</code> if both are defined.
</li>
<li class="listitem">
<code class="literal">args.api_key</code>:  API key of elasticsearch endpoint in the format <code class="literal">base64encode(api_key_id:api_key_secret)</code>. Mandatory when <code class="literal">args.username</code>  and <code class="literal">args.password</code> are not provided. Will be ignored if <code class="literal">args.username</code>/<code class="literal">args.password</code> are defined.
</li>
<li class="listitem">
<code class="literal">args.es_datastream_name</code>: Name of data stream or index where logs should be forwarded to. Lambda supports automatic routing of various AWS service logs to the corresponding data streams for further processing and storage in the Elasticsearch cluster. It supports automatic routing of <code class="literal">aws.cloudtrail</code>, <code class="literal">aws.cloudwatch_logs</code>, <code class="literal">aws.elb_logs</code>, <code class="literal">aws.firewall_logs</code>, <code class="literal">aws.vpcflow</code>, and <code class="literal">aws.waf</code> logs. For other log types, if using data streams, you can optionally set its value in the configuration file according to the naming convention for data streams and available integrations. If the <code class="literal">es_datastream_name</code> is not specified and it cannot be matched with any of the above AWS services, then the value will be set to <code class="literal">logs-generic-default</code>. In versions <span class="strong strong"><strong>v0.29.1</strong></span> and below, this configuration parameter was named <code class="literal">es_index_or_datastream_name</code>. Rename the configuration parameter to <code class="literal">es_datastream_name</code> in your <code class="literal">config.yaml</code> file on the S3 bucket to continue using it in the future version. The older name <code class="literal">es_index_or_datastream_name</code> is deprecated as of version <span class="strong strong"><strong>v0.30.0</strong></span>. The related backward compatibility code is removed from version <span class="strong strong"><strong>v1.0.0</strong></span>.
</li>
<li class="listitem">
<code class="literal">args.batch_max_actions</code>: (Optional) Maximum number of actions to send in a single bulk request. Default value: 500.
</li>
<li class="listitem">
<code class="literal">args.batch_max_bytes</code>: (Optional) Maximum size in bytes to send in a single bulk request. Default value: 10485760 (10MB).
</li>
<li class="listitem">
<code class="literal">args.ssl_assert_fingerprint</code>: (Optional) SSL fingerprint for self-signed SSL certificate on HTTPS transport.
</li>
</ul>
</div>
<p>For <code class="literal">logstash</code> the following arguments are supported:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">args.logstash_url</code>: URL of Logstash endpoint in the format <code class="literal">http(s)://host:port</code>
</li>
<li class="listitem">
<code class="literal">args.username</code>: (Optional) Username of the Logstash instance to connect to. Mandatory if HTTP Basic authentication is enabled in Logstash.
</li>
<li class="listitem">
<code class="literal">args.password</code>: (Optional) Password of the Logstash instance to connect to. Mandatory if HTTP Basic authentication is enabled in Logstash.
</li>
<li class="listitem">
<code class="literal">args.max_batch_size</code>: (Optional) Maximum number of events to send in a single HTTP(s) request. Default value: 500
</li>
<li class="listitem">
<code class="literal">args.compression_level</code>: (Optional) The GZIP compression level for HTTP(s) requests towards Logstash. It can be any integer value between 1 (minimum compression, best performance, highest amount of bytes sent) and 9 (maximum compression, worst performance, lowest amount of bytes sent). Default value: 1
</li>
<li class="listitem">
<code class="literal">args.ssl_assert_fingerprint</code>: (Optional) SSL fingerprint for self-signed SSL certificate on HTTPS transport.
</li>
</ul>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-forwarder-define-deploy-parameters"></a>Define deployment parameters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h4>
</div></div></div>
<p>Whichever SAR deployment method you choose, you must define the following parameters correctly for your setup. This section explains the types of parameters and provides guidance on how to set them to match your deployment(s).</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_general_configuration"></a>General configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
</div></div></div>
<p>These parameters define the general configuration and behaviour for the forwarder.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">ElasticServerlessForwarderS3ConfigFile</code>: Set this value to the location of your <code class="literal">config.yaml</code> in S3 URL format: <code class="literal">s3://bucket-name/config-file-name</code>. This will populate the <code class="literal">S3_CONFIG_FILE</code> environment variable for the forwarder.
</li>
<li class="listitem">
<code class="literal">ElasticServerlessForwarderSSMSecrets</code>: Add a comma delimited list of AWS SSM Secrets ARNs used in the <code class="literal">config.yml</code> (if any).
</li>
<li class="listitem">
<code class="literal">ElasticServerlessForwarderKMSKeys</code>: Add a comma delimited list of AWS KMS Keys ARNs to be used for decrypting AWS SSM Secrets, Kinesis Data Streams, SQS queue, or S3 buckets (if any).
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you include all the KMS keys used to encrypt the data. For example, S3 buckets are often encrypted, so the Lambda function needs access to that key to get the object.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_inputs"></a>Inputs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
</div></div></div>
<p>These parameters define your specific <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs" title="Inputs">Inputs</a> or <em>event triggers</em>.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">ElasticServerlessForwarderSQSEvents</code>: Add a comma delimited list of Direct SQS queue ARNs to set as event triggers for the forwarder (if any).
</li>
<li class="listitem">
<code class="literal">ElasticServerlessForwarderS3SQSEvents</code>: Add a comma delimited list of S3 SQS Event Notifications ARNs to set as event triggers for the forwarder (if any).
</li>
<li class="listitem">
<code class="literal">ElasticServerlessForwarderKinesisEvents</code>: Add a comma delimited list of Kinesis Data Stream ARNs to set as event triggers for the forwarder (if any).
</li>
<li class="listitem">
<code class="literal">ElasticServerlessForwarderCloudWatchLogsEvents</code>: Add a comma delimited list of Cloudwatch Logs log group ARNs to set subscription filters on the forwarder (if any).
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Make sure you reference the ARNs specified in your <code class="literal">config.yaml</code>, and leave any settings for unused inputs blank.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_s3_bucket_permissions"></a>S3 Bucket permissions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
</div></div></div>
<p>These parameters define the permissions required in order to access the associated S3 Buckets.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">ElasticServerlessForwarderS3Buckets</code>: Add a comma delimited list of S3 bucket ARNs that are sources for the S3 SQS Event Notifications (if any).
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_network"></a>Network<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
</div></div></div>
<p>These parameters define the network settings for your environment.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">ElasticServerlessForwarderSecurityGroups</code>: Add a comma delimited list of security group IDs to attach to the forwarder. Along with <code class="literal">ElasticServerlessForwarderSubnets</code>, these settings will define the AWS VPC the forwarder will belong to. Leave blank if you don&#8217;t want the forwarder to belong to any specific AWS VPC.
</li>
<li class="listitem">
<code class="literal">ElasticServerlessForwarderSubnets</code>: Add a comma delimited list of subnet IDs for to the forwarder. Along with <code class="literal">ElasticServerlessForwarderSecurityGroups</code>, these settings will define the AWS VPC the forwarder will belong to. Leave blank if you don&#8217;t want the forwarder to belong to any specific AWS VPC.
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you are setting up an an AWS VPC for the forwarder, review the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-troubleshooting-vpc-prerequisites" title="Prerequisites when attached to a VPC">VPC prerequisites</a>.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-forwarder-deploy-sar"></a>Deploy Elastic Serverless Forwarder from SAR<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h4>
</div></div></div>
<p>There are several deployment methods available via the AWS Serverless Application Repository (SAR):</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-deploy-console" title="Deploy using AWS Console">Deploy using AWS Console</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-deploy-cloudformation" title="Deploy using Cloudformation">Deploy using Cloudformation</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-deploy-terraform" title="Deploy using Terraform">Deploy using Terraform</a>
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>To deploy the forwarder directly without using SAR, refer to <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-direct-deploy" title="Deploy Elastic Serverless Forwarder directly">Deploy Elastic Serverless Forwarder directly</a></p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-forwarder-deploy-console"></a>Deploy using AWS Console<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
</div></div></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Log in to AWS console and open <span class="strong strong"><strong>Lambda</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Applications</strong></span> and then <span class="strong strong"><strong>Create application</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Serverless application</strong></span> and search for <span class="strong strong"><strong>elastic-serverless-forwarder</strong></span>.
</li>
<li class="listitem">
<p>Select <span class="strong strong"><strong>elastic-serverless-forwarder</strong></span> from the search results (ignoring any application beginning <span class="strong strong"><strong>helper-</strong></span>).</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/aws-serverless-forwarder-create-function.png" alt="Create Elastic Serverless Forwarder Lambda function within SAR">
</div>
</div>
</li>
<li class="listitem">
Complete the <span class="strong strong"><strong>Application settings</strong></span> according to <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-define-deploy-parameters" title="Define deployment parameters">Define deployment parameters</a>
</li>
<li class="listitem">
After your settings have been added, click <span class="strong strong"><strong>Deploy</strong></span>.
</li>
<li class="listitem">
On the Applications page for <span class="strong strong"><strong>serverlessrepo-elastic-serverless-forwarder</strong></span>, click <span class="strong strong"><strong>Deployments</strong></span>.
</li>
<li class="listitem">
Refresh the <span class="strong strong"><strong>Deployment history</strong></span> until you see the <code class="literal">Create complete</code> status update. It should take around 5 minutes to deploy &mdash; if the deployment fails for any reason, the create events will be rolled back and you will be able to see an explanation for which event failed.
</li>
<li class="listitem">
<p>(Optional) To enable Elastic APM instrumentation for your new deployment:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Lambda &gt; Functions</strong></span> within AWS console, and find and select the function with <span class="strong strong"><strong>serverlessrepo-</strong></span>.
</li>
<li class="listitem">
Go to <span class="strong strong"><strong>Configuration</strong></span> tab and select <span class="strong strong"><strong>Environment Variables</strong></span>
</li>
<li class="listitem">
<p>Add the following environment variables:</p>
<pre class="literallayout">| Key                       | Value  |
|---------------------------|--------|
|`ELASTIC_APM_ACTIVE`       | `true` |
|`ELASTIC_APM_SECRET_TOKEN` | token  |
|`ELASTIC_APM_SERVER_URL`	  | url    |</pre>

</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you have already successfully deployed the forwarder but want to update the application (for example, if a new version of the Lambda function is released), you should go through this deploy step again and use the same <span class="strong strong"><strong>Application name</strong></span>. This will ensure the function is updated rather than duplicated or created anew.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-forwarder-deploy-cloudformation"></a>Deploy using Cloudformation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
</div></div></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Use the following code to get the semantic version of the latest application:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">aws serverlessrepo list-application-versions --application-id arn:aws:serverlessrepo:eu-central-1:267093732750:applications/elastic-serverless-forwarder</pre>
</div>
</li>
<li class="listitem">
<p>Save the following YAML content as <code class="literal">sar-application.yaml</code> and fill in the correct parameters according to <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-define-deploy-parameters" title="Define deployment parameters">Define deployment parameters</a>:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">    Transform: AWS::Serverless-2016-10-31
    Resources:
      SarCloudformationDeployment:
        Type: AWS::Serverless::Application
        Properties:
          Location:
            ApplicationId: 'arn:aws:serverlessrepo:eu-central-1:267093732750:applications/elastic-serverless-forwarder'
            SemanticVersion: '%SEMANTICVERSION%'  ## SET TO CORRECT SEMANTIC VERSION (MUST BE GREATER THAN 1.6.0)
          Parameters:
            ElasticServerlessForwarderS3ConfigFile: ""
            ElasticServerlessForwarderSSMSecrets: ""
            ElasticServerlessForwarderKMSKeys: ""
            ElasticServerlessForwarderSQSEvents: ""
            ElasticServerlessForwarderS3SQSEvents: ""
            ElasticServerlessForwarderKinesisEvents: ""
            ElasticServerlessForwarderCloudWatchLogsEvents: ""
            ElasticServerlessForwarderS3Buckets: ""
            ElasticServerlessForwarderSecurityGroups: ""
            ElasticServerlessForwarderSubnets: ""</pre>
</div>
</li>
<li class="listitem">
<p>Deploy the Lambda function from SAR by running the following command:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">    aws cloudformation deploy --template-file sar-application.yaml --stack-name esf-cloudformation-deployment --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND</pre>
</div>
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Starting from <span class="strong strong"><strong>v1.4.0</strong></span>, if you want to update the Events settings for the forwarder, you do not need to manually delete existing settings before applying new settings.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-forwarder-deploy-terraform"></a>Deploy using Terraform<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
</div></div></div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Save the following yaml content as <code class="literal">sar-application.tf</code> and fill in the correct parameters according to <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-define-deploy-parameters" title="Define deployment parameters">Define deployment parameters</a>:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">  provider "aws" {
    region = ""  ## FILL WITH THE AWS REGION WHERE YOU WANT TO DEPLOY THE ELASTIC SERVERLESS FORWARDER
  }
  data "aws_serverlessapplicationrepository_application" "esf_sar" {
    application_id = "arn:aws:serverlessrepo:eu-central-1:267093732750:applications/elastic-serverless-forwarder"
  }
  resource "aws_serverlessapplicationrepository_cloudformation_stack" "esf_cf_stak" {
    name             = "terraform-elastic-serverless-forwarder"
    application_id   = data.aws_serverlessapplicationrepository_application.esf_sar.application_id
    semantic_version = data.aws_serverlessapplicationrepository_application.esf_sar.semantic_version
    capabilities     = data.aws_serverlessapplicationrepository_application.esf_sar.required_capabilities
  parameters = {
      ElasticServerlessForwarderS3ConfigFile = ""
      ElasticServerlessForwarderSSMSecrets = ""
      ElasticServerlessForwarderKMSKeys = ""
      ElasticServerlessForwarderSQSEvents = ""
      ElasticServerlessForwarderS3SQSEvents = ""
      ElasticServerlessForwarderKinesisEvents = ""
      ElasticServerlessForwarderCloudWatchLogsEvents = ""
      ElasticServerlessForwarderS3Buckets = ""
      ElasticServerlessForwarderSecurityGroups = ""
      ElasticServerlessForwarderSubnets = ""
    }
  }</pre>
</div>
</li>
<li class="listitem">
<p>Deploy the function from SAR by running the following commands:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">  terrafrom init
  terrafrom apply</pre>
</div>
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>From <span class="strong strong"><strong>v1.4.0</strong></span> and above, if you want to update the Events settings for the deployment, it is no longer required to manually delete existing settings before applying the new settings.</p>
<p>Due to a <a href="https://github.com/hashicorp/terraform-provider-aws/issues/24771" class="ulink" target="_top">Terraform bug</a> related to <code class="literal">aws_serverlessapplicationrepository_application</code>, if you want to delete existing Event parameters you have to set the related <code class="literal">aws_serverlessapplicationrepository_cloudformation_stack.parameters</code> to a blank space value (<code class="literal">" "</code>) instead of an empty string (<code class="literal">""</code>).</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-forwarder-direct-deploy"></a>Deploy Elastic Serverless Forwarder directly<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h4>
</div></div></div>
<p>For more customisation options during deployment, from version <code class="literal">1.6.0</code> and above you can deploy the Elastic Serverless Forwarder directly to your AWS Account without using SAR. This enables you to customize the event source settings for the inputs (i.e. triggers) one-by-one.</p>
<p>To deploy the forwarder directly, you have to:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-deploy-kibana" title="Install AWS integration assets in Kibana">Install AWS integration assets in Kibana</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#sample-s3-config-file" title="Create and upload config.yaml to S3 bucket">Create and upload <code class="literal">config.yaml</code> to S3 bucket</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#sample-direct-publish-config-file" title="Create publish-config.yaml for the publishing script">Create <code class="literal">publish-config.yaml</code> for the publishing script</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-run-publish-script" title="Run the publishing script">Run the publishing script</a>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="sample-direct-publish-config-file"></a>Create <code class="literal">publish-config.yaml</code> for the publishing script<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
</div></div></div>
<p>To deploy the forwarder directly, you need to define a <code class="literal">publish-config.yaml</code> file and pass this as an argument in the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-run-publish-script" title="Run the publishing script">publishing script</a>.</p>
<p>Save the following YAML content as <code class="literal">publish-config.yaml</code> and edit as required before running the publishing script. You should remove any inputs or arguments you are not using.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">kinesis-data-stream:
    - arn: "arn:aws:kinesis:%REGION%:%ACCOUNT%:stream/%STREAMNAME%"
      batch_size: 10
      batching_window_in_second: 0
      starting_position: TRIM_HORIZON
      starting_position_timestamp: 0
      parallelization_factor: 1
sqs:
    - arn: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
      batch_size: 10
      batching_window_in_second: 0
s3-sqs:
    - arn: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
      batch_size: 10
      batching_window_in_second: 0
cloudwatch-logs:
    - arn: "arn:aws:logs:%AWS_REGION%:%AWS_ACCOUNT_ID%:log-group:%LOG_GROUP_NAME%:*"
    - arn: "arn:aws:logs:%AWS_REGION%:%AWS_ACCOUNT_ID%:log-group:%LOG_GROUP_NAME%:log-stream:%LOG_STREAM_NAME%"
ssm-secrets:
  - "arn:aws:secretsmanager:%AWS_REGION%:%AWS_ACCOUNT_ID%:secret:%SECRET_NAME%"
kms-keys:
    - "arn:aws:kms:%AWS_REGION%:%AWS_ACCOUNT_ID%:key/%KMS_KEY_UUID%"
s3-buckets:
    - "arn:aws:s3:::%BUCKET_NAME%"
subnets:
    - "%SUBNET_ID%"
security-groups:
    - "%SECURITY_ID%"
s3-config-file: "s3://%S3_CONFIG_BUCKET_NAME%/%S3_CONFIG_OBJECT_KEY%"
continuing-queue:
    batch_size: 10
    batching_window_in_second: 0</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="direct-publish-config-file-fields"></a>Fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
</div></div></div>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p><code class="literal">kinesis-data-stream.[]</code></p></td>
<td align="left" valign="top"><p>List of <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-kinesis" title="Amazon Kinesis Data Streams">Amazon Kinesis Data Streams</a> (i.e. triggers) for the forwarder, matching those defined in your <a class="xref" href="aws-elastic-serverless-forwarder.html#sample-s3-config-file" title="Create and upload config.yaml to S3 bucket">Create and upload <code class="literal">config.yaml</code> to S3 bucket</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">kinesis-data-stream.[].arn</code></p></td>
<td align="left" valign="top"><p>ARN of the AWS Kinesis Data Stream.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">kinesis-data-stream.[].batch_size</code></p></td>
<td align="left" valign="top"><p>Set this value above the default (<code class="literal">10</code>) if you experience ingestion delays in your output <span class="strong strong"><strong>and</strong></span> <code class="literal">GetRecords.IteratorAgeMilliseconds</code> and <code class="literal">IncomingRecords</code> Kinesis CloudWatch metrics for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-kinesis" title="Amazon Kinesis Data Streams">Amazon Kinesis Data Streams</a> keep increasing <span class="strong strong"><strong>and</strong></span> the average execution time of the forwarder is below 14 minutes. This will increase the number of records the forwarder will process in a single execution for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-kinesis" title="Amazon Kinesis Data Streams">Amazon Kinesis Data Streams</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">kinesis-data-stream.[].batching_window_in_second</code></p></td>
<td align="left" valign="top"><p>Set this value above the default (<code class="literal">0</code>) if you experience ingestion delays in your output <span class="strong strong"><strong>and</strong></span> <code class="literal">GetRecords.IteratorAgeMilliseconds</code> and <code class="literal">IncomingRecords</code> Kinesis CloudWatch metrics for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-kinesis" title="Amazon Kinesis Data Streams">Amazon Kinesis Data Streams</a> keep increasing <span class="strong strong"><strong>and</strong></span> the average execution time of the forwarder is below 14 minutes. This will increase the number of records the forwarder will process in a single execution for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-kinesis" title="Amazon Kinesis Data Streams">Amazon Kinesis Data Streams</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">kinesis-data-stream.[].starting_position</code></p></td>
<td align="left" valign="top"><p>Change this value from the default (<code class="literal">TRIM_HORIZON</code>) if you want to change the starting position of the records processed by the forwarder for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-kinesis" title="Amazon Kinesis Data Streams">Amazon Kinesis Data Streams</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">kinesis-data-stream.[].starting_position_timestamp</code></p></td>
<td align="left" valign="top"><p>Set this value to the time from which to start reading (in Unix time seconds) if you set <code class="literal">ElasticServerlessForwarderKinesisStartingPosition</code> to "AT_TIMESTAMP".</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">kinesis-data-stream.[].parallelization_factor</code></p></td>
<td align="left" valign="top"><p>Defines the number of forwarder functions that can run concurrently per shard (default is <code class="literal">1</code>). Increase this value if you experience ingestion delays in your output <span class="strong strong"><strong>and</strong></span> <code class="literal">GetRecords.IteratorAgeMilliseconds</code> and <code class="literal">IncomingRecords</code> Kinesis CloudWatch metrics for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-kinesis" title="Amazon Kinesis Data Streams">Amazon Kinesis Data Streams</a> keep increasing <span class="strong strong"><strong>and</strong></span> the average execution time of the forwarder is below 14 minutes. This will increase the number of records processed concurrently for <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-kinesis" title="Amazon Kinesis Data Streams">Amazon Kinesis Data Streams</a>. For more info, refer to <a href="https://docs.aws.amazon.com/lambda/latest/dg/with-kinesis.html" class="ulink" target="_top">AWS Kinesis docs</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">sqs.[]</code></p></td>
<td align="left" valign="top"><p>List of <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-direct" title="Amazon SQS message payload">Amazon SQS message payload</a> (i.e. triggers) for the forwarder, matching those defined in your <a class="xref" href="aws-elastic-serverless-forwarder.html#sample-s3-config-file" title="Create and upload config.yaml to S3 bucket">Create and upload <code class="literal">config.yaml</code> to S3 bucket</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">sqs.[].arn</code></p></td>
<td align="left" valign="top"><p>ARN of the AWS SQS queue trigger input.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">sqs.[].batch_size</code></p></td>
<td align="left" valign="top"><p>Set this value above the default (<code class="literal">10</code>) if you experience ingestion delays in your output <span class="strong strong"><strong>and</strong></span> <code class="literal">ApproximateNumberOfMessagesVisible</code> and <code class="literal">ApproximateAgeOfOldestMessage</code> SQS CloudWatch metrics for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-direct" title="Amazon SQS message payload">Amazon SQS message payload</a> keep increasing <span class="strong strong"><strong>and</strong></span> the average execution time of the forwarder is below 14 minutes. This will increase the number of messages the forwarder will process in a single execution for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-direct" title="Amazon SQS message payload">Amazon SQS message payload</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">sqs.[].batching_window_in_second</code></p></td>
<td align="left" valign="top"><p>Set this value above the default (<code class="literal">0</code>) if you experience ingestion delays in your output <span class="strong strong"><strong>and</strong></span> <code class="literal">ApproximateNumberOfMessagesVisible</code> and <code class="literal">ApproximateAgeOfOldestMessage</code> SQS CloudWatch metrics for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-direct" title="Amazon SQS message payload">Amazon SQS message payload</a> keep increasing <span class="strong strong"><strong>and</strong></span> the average execution time of the forwarder is below 14 minutes. This will increase the number of messages the forwarder will process in a single execution for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-direct" title="Amazon SQS message payload">Amazon SQS message payload</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">s3-sqs.[]</code></p></td>
<td align="left" valign="top"><p>List of <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-s3" title="Amazon S3 (via SQS event notifications)">Amazon S3 (via SQS event notifications)</a> (i.e. triggers) for the forwarder, matching those defined in your <a class="xref" href="aws-elastic-serverless-forwarder.html#sample-s3-config-file" title="Create and upload config.yaml to S3 bucket">Create and upload <code class="literal">config.yaml</code> to S3 bucket</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">s3-sqs.[].arn</code></p></td>
<td align="left" valign="top"><p>ARN of the AWS SQS queue receiving S3 Notifications as trigger input.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">s3-sqs.[].batch_size</code></p></td>
<td align="left" valign="top"><p>Set this value above the default (<code class="literal">10</code>) if you experience ingestion delays in your output <span class="strong strong"><strong>and</strong></span> <code class="literal">ApproximateNumberOfMessagesVisible</code> and <code class="literal">ApproximateAgeOfOldestMessage</code> SQS CloudWatch metrics for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-s3" title="Amazon S3 (via SQS event notifications)">Amazon S3 (via SQS event notifications)</a> keep increasing <span class="strong strong"><strong>and</strong></span> the average execution time of the forwarder is below 14 minutes. This will increase the number of messages the forwarder will process in a single execution for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-s3" title="Amazon S3 (via SQS event notifications)">Amazon S3 (via SQS event notifications)</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">s3-sqs.[].batching_window_in_second</code></p></td>
<td align="left" valign="top"><p>Set this value above the default (<code class="literal">0</code>) if you experience ingestion delays in your output <span class="strong strong"><strong>and</strong></span> <code class="literal">ApproximateNumberOfMessagesVisible</code> and <code class="literal">ApproximateAgeOfOldestMessage</code> SQS CloudWatch metrics for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-s3" title="Amazon S3 (via SQS event notifications)">Amazon S3 (via SQS event notifications)</a> keep increasing <span class="strong strong"><strong>and</strong></span> the average execution time of the forwarder is below 14 minutes. This will increase the number of messages the forwarder will process in a single execution for the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-s3" title="Amazon S3 (via SQS event notifications)">Amazon S3 (via SQS event notifications)</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">cloudwatch-logs.[]</code></p></td>
<td align="left" valign="top"><p>List of <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-cloudwatch" title="Amazon CloudWatch Logs subscription filters">Amazon CloudWatch Logs subscription filters</a> (i.e. triggers) for the forwarder, matching those defined in your <a class="xref" href="aws-elastic-serverless-forwarder.html#sample-s3-config-file" title="Create and upload config.yaml to S3 bucket">Create and upload <code class="literal">config.yaml</code> to S3 bucket</a>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">cloudwatch-logs.[].arn</code></p></td>
<td align="left" valign="top"><p>ARN of the AWS CloudWatch Logs trigger input (accepts both CloudWatch Logs Log Group and CloudWatch Logs Log Stream ARNs).</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">ssm-secrets.[]</code></p></td>
<td align="left" valign="top"><p>List of AWS SSM Secrets ARNs used in your <code class="literal">config.yml</code> (if any).</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">kms-keys.[]</code></p></td>
<td align="left" valign="top"><p>List of AWS KMS Keys ARNs to be used for decrypting AWS SSM Secrets, Kinesis Data Streams or SQS queues (if any).</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">s3-buckets.[]</code></p></td>
<td align="left" valign="top"><p>List of S3 bucket ARNs that are sources for the S3 SQS Event Notifications (if any).</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">subnets.[]</code></p></td>
<td align="left" valign="top"><p>A list of subnets IDs for the forwarder. Along with <code class="literal">security-groups.[]</code>, these settings will define the AWS VPC the forwarder will belong to. Leave blank if you don&#8217;t want the forwarder to belong to any specific AWS VPC.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">security-groups.[]</code></p></td>
<td align="left" valign="top"><p>List of security group IDs to attach to the forwarder. Along with <code class="literal">subnets.[]</code>, these settings will define the AWS VPC the forwarder will belong to. Leave blank if you don&#8217;t want to have the forwarder belong to any specific AWS VPC.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">s3-config-file</code></p></td>
<td align="left" valign="top"><p>Set this value to the location of your forwarder configuration file in S3 URL format: <code class="literal">s3://bucket-name/config-file-name</code>. This will populate the <code class="literal">S3_CONFIG_FILE</code> environment variable for the forwarder.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">continuing-queue.batch_size</code></p></td>
<td align="left" valign="top"><p>Set this value above the default (<code class="literal">10</code>) if you experience ingestion delays in your output <span class="strong strong"><strong>and</strong></span> <code class="literal">ApproximateNumberOfMessagesVisible</code> and <code class="literal">ApproximateAgeOfOldestMessage</code> SQS CloudWatch metrics for the <em>Continuing queue</em> keep increasing <span class="strong strong"><strong>and</strong></span> the average execution time of the forwarder is below 14 minutes. This will increase the number of messages the forwarder will process in a single execution for the <em>Continuing queue</em>.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">continuing-queue.batching_window_in_second</code></p></td>
<td align="left" valign="top"><p>Set this value above the default (<code class="literal">0</code>) if you experience ingestion delays in your output <span class="strong strong"><strong>and</strong></span> <code class="literal">ApproximateNumberOfMessagesVisible</code> and <code class="literal">ApproximateAgeOfOldestMessage</code> SQS CloudWatch metrics for the <em>Continuing queue</em> keep increasing <span class="strong strong"><strong>and</strong></span> the average execution time of the forwarder is below 14 minutes. This will increase the number of messages the forwarder will process in a single execution for the <em>Continuing queue</em>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-forwarder-run-publish-script"></a>Run the publishing script<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h5>
</div></div></div>
<p>A bash script for publishing the Elastic Serverless Forwarder directly to your AWS account is available from the <a href="https://github.com/elastic/elastic-serverless-forwarder" class="ulink" target="_top">Elastic Serverless Forwarder repository</a>.</p>
<p>Download the <a href="https://raw.githubusercontent.com/elastic/elastic-serverless-forwarder/lambda-v1.6.0/publish_lambda.sh" class="ulink" target="_top"><code class="literal">publish_lambda.sh</code> script</a> and follow the instructions below.</p>
<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_script_arguments"></a>Script arguments<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h6>
</div></div></div>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash"> $ ./publish_lambda.sh
    AWS CLI (https://aws.amazon.com/cli/), SAM (https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html) and Python3.9 with pip3 required
    Please, before launching the tool execute "$ pip3 install ruamel.yaml"
Usage: ./publish_lambda.sh config-path lambda-name forwarder-tag bucket-name region
    Arguments:
    config-path: full path to the publish configuration
    lambda-name: name of the lambda to be published in the account
    forwarder-tag: tag of the elastic serverless forwarder to publish
    bucket-name: bucket name where to store the zip artifact for the lambda
                 (it will be created if it doesn't exists, otherwise
                  you need already to have proper access to it)
    region: region where to publish in</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_prerequisites"></a>Prerequisites<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h6>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Python3.9 with pip3 is required to run the script
</li>
<li class="listitem">
<a href="https://aws.amazon.com/cli/" class="ulink" target="_top">AWS CLI</a>, <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html" class="ulink" target="_top">SAM CLI</a> and the <a href="https://pypi.org/project/ruamel.yaml/" class="ulink" target="_top">ruamel.yaml package</a> must also be installed
</li>
</ul>
</div>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">$ pip3 install awscli aws-sam-cli ruamel.yaml</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_running_the_script"></a>Running the script<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h6>
</div></div></div>
<p>Assuming <code class="literal">publish-config.yaml</code> in saved in the same directory you intend to run <code class="literal">publish_lambda.sh</code> from, here&#8217;s an example:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">$ ./publish_lambda.sh publish-config.yaml forwarder-lambda lambda-v1.6.0 s3-lambda-artifact-bucket-name eu-central-1</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_updating_to_a_new_version_via_script"></a>Updating to a new version via script<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h6>
</div></div></div>
<p>You can update the version of a published Elastic Serverless Forwarder without changing its configuration by running the publishing script again and passing a <span class="strong strong"><strong>new</strong></span> <a href="https://github.com/elastic/elastic-serverless-forwarder/tags" class="ulink" target="_top"><code class="literal">forwarder-tag</code></a>:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">$ ./publish_lambda.sh publish-config.yaml forwarder-lambda lambda-v1.7.0 s3-lambda-artifact-bucket-name eu-central-1</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The above examples show the forwarder being updated from <code class="literal">lambda-v1.6.0</code> to <code class="literal">lambda-v1.7.0</code>.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_changing_configuration_via_script"></a>Changing configuration via script<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h6>
</div></div></div>
<p>If you want to change the configuration of a published Elastic Serverless Forwarder without changing its version, you can update the <code class="literal">publish-config.yaml</code> and run the script again using the <span class="strong strong"><strong>same</strong></span> <code class="literal">forwarder-tag</code>:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">$ ./publish_lambda.sh publish-config.yaml forwarder-lambda lambda-v1.6.0 s3-lambda-artifact-bucket-name eu-central-1</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The above example shows an existing <code class="literal">lambda-v1.6.0</code> configuration being updated without changing version.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="_using_the_script_for_multiple_deployments"></a>Using the script for multiple deployments<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-deploy-elastic-serverless-forwarder.asciidoc">edit</a></h6>
</div></div></div>
<p>If you want to use the publish script for deploying the forwarder with different configurations, create two different <code class="literal">publish-config.yaml</code> files with unique names and run the publishing script twice, with correct references to the <code class="literal">config-path</code> and <code class="literal">lambda-name</code>:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">$ ./publish_lambda.sh publish-config-for-first-lambda.yaml first-lambda lambda-v1.6.0 s3-lambda-artifact-bucket-name eu-central-1

$ ./publish_lambda.sh publish-config-for-second-lambda.yaml second-lambda lambda-v1.6.0 ss3-lambda-artifact-bucket-name eu-central-1</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The above example publishes two versions of the forwarder, each with different configurations i.e. <code class="literal">publish-config-for-first-lambda.yaml</code> and <code class="literal">first-lambda</code> vs. <code class="literal">publish-config-for-second-lambda.yaml</code> and <code class="literal">second-lambda</code>.</p>
</div>
</div>
</div>

</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="aws-elastic-serverless-forwarder-configuration"></a>Configuration options for Elastic Serverless Forwarder<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h3>
</div></div></div>

<p>Learn more about configuration options for Elastic Serverless Forwarder, including more detail on permissions and policies, automatic routing of AWS service logs, and how to use AWS Secrets Manager for authentication.</p>
<p>You can transform or enrich data from AWS as it is parsed by the forwarder. This includes examples such as using tags and filters to organise your data and exclude specific messages, automatically discovering and collecting JSON content, and managing multiline messages effectively.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#lambda-permissions-policies" title="Permissions and policies">Permissions and policies</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#use-secrets-manager" title="Use AWS Secrets Manager">Use AWS Secrets Manager</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-route-service-logs" title="Route AWS service logs">Route AWS service logs</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-use-tags-filters" title="Use tags and filters">Use tags and filters</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-json-content" title="JSON content discovery">JSON content discovery</a>
</li>
<li class="listitem">
<a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-manage-multiline-messages" title="Manage multiline messages">Manage multiline messages</a>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="lambda-permissions-policies"></a>Permissions and policies<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>A Lambda function&#8217;s execution role is an AWS Identity and Access Management (IAM) role that grants the function permission to access AWS services and resources. This role is automatically created when the function is deployed and Lambda assumes this role when the function is invoked.</p>
<p>When you provide the ARNs of AWS resources the forwarder will interact with, the Cloudformation template will create the correct IAM role with the appropriate IAM policies.</p>
<p>You can view the execution role associated with your Lambda function from the <span class="strong strong"><strong>Configuration &gt; Permissions</strong></span> section within . By default this role starts with the name <span class="strong strong"><strong>serverlessrepo-</strong></span>. When the role is created, a custom policy is added to grant Lambda minimum permissions to be able to use the configured SQS queue, S3 buckets, Kinesis data stream, CloudWatch Logs log groups, Secrets manager (if using), and SQS replay queue.</p>
<p>The forwarder is granted the following <code class="literal">ManagedPolicyArns</code> permissions, which are automatically added by default to the Events configuration (if relevant):</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
arn:aws:iam::aws:policy/service-role/AWSLambdaKinesisExecutionRole
arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole</pre>
</div>
<p>In addition to these basic permissions, the following permissions are added when the function is created by the Cloudformation template of the function:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
For SQS queue resources specified in the <code class="literal">SQS_CONTINUE_URL</code> and <code class="literal">SQS_REPLAY_URL</code> environment variables, the following action is allowed: <code class="literal">sqs:SendMessage</code>
</li>
<li class="listitem">
For S3 bucket resources specified in the <code class="literal">S3_CONFIG_FILE</code> environment variable, the following action is allowed on the S3 buckets' config file object key: <code class="literal">s3:GetObject</code>
</li>
<li class="listitem">
For every S3 bucket resource sending notifications to SQS queues, the following action is allowed on the S3 buckets: <code class="literal">s3:ListBucket</code>
</li>
<li class="listitem">
For every S3 bucket resource sending notifications to SQS queues, the following action is allowed on the S3 buckets' keys: <code class="literal">s3:GetObject</code>
</li>
<li class="listitem">
For every Secret Manager secret that you want to refer in the <code class="literal">config.yaml</code> file, the following action is allowed: <code class="literal">secretsmanager:GetSecretValue</code>
</li>
<li class="listitem">
Excepting the default key used to encrypt your Secret Manager secrets with, the following action is allowed for every decrypt key: <code class="literal">kms:Decrypt</code>
</li>
<li class="listitem">
<p>If any CloudWatch Logs log groups are set as Lambda inputs, the following actions are allowed for the resource:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">arn:aws:logs:%AWS_REGION%:%AWS_ACCOUNT_ID%:log-group:*:*</code>
</li>
<li class="listitem">
<code class="literal">logs:DescribeLogGroups</code>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="lambda-policy-cloudwatch"></a>Lambda resource-based policy for CloudWatch Logs subscription filter input<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>For CloudWatch Logs subscription filter log group resources that you want to use as triggers for the forwarder, the following is allowed as a resource-based policy in separate Policy statements:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">  * Principal: logs.%AWS_REGION%.amazonaws.com
  * Action: lambda:InvokeFunction
  * Source ARN: arn:aws:logs:%AWS_REGION%:%AWS_ACCOUNT_ID%:log-group:%LOG_GROUP_NAME%:*</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="use-secrets-manager"></a>Use AWS Secrets Manager<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>AWS Secrets Manager enables you to replace hardcoded credentials in your code, including passwords, with an API call to Secrets Manager to retrieve the secret programmatically. For more info, refer to the <a href="https://docs.aws.amazon.com/secretsmanager/index.html" class="ulink" target="_top">AWS Secrets Manager documentation</a>.</p>
<p>There are 2 types of secrets that can be used:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
SecretString (plain text or key/value pairs)
</li>
<li class="listitem">
SecretBinary
</li>
</ul>
</div>
<p>The following code shows API calls to AWS Secrets Manager:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">inputs:
  - type: "s3-sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    outputs:
      - type: "elasticsearch"
        args:
          elasticsearch_url: "arn:aws:secretsmanager:eu-central-1:123456789:secret:es_url"
          username: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:username"
          password: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:password"
          es_datastream_name: "logs-generic-default"</pre>
</div>
<p>To use a <span class="strong strong"><strong>plain text</strong></span> or <span class="strong strong"><strong>binary</strong></span> secret, note the following format for the ARN:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">arn:aws:secretsmanager:AWS_REGION:AWS_ACCOUNT_ID:secret:SECRET_NAME</pre>
</div>
<p>In order to use a <span class="strong strong"><strong>key/value</strong></span> pair secret, you need to provide the key at the end of the arn, as per:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">arn:aws:secretsmanager:AWS_REGION:AWS_ACCOUNT_ID:secret:SECRET_NAME:SECRET_KEY</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Secrets from different regions are supported, but the only version currently retrieved for a secret is <code class="literal">AWSCURRENT</code>.
</li>
<li class="listitem">
You cannot use the same secret for both plain text and key/value pairs.
</li>
<li class="listitem">
Secrets are case-sensitive.
</li>
<li class="listitem">
Any configuration error or typo in the <code class="literal">config.yaml</code> file will be ignored (or exceptions raised) and secrets will not be retrieved.
</li>
<li class="listitem">
Keys must exist in the AWS Secrets Manager.
</li>
<li class="listitem">
Empty values for a given key are not allowed.
</li>
</ul>
</div>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-route-service-logs"></a>Route AWS service logs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>For <code class="literal">S3 SQS Event Notifications</code> inputs, the Elastic Serverless Forwarder supports automatic routing of several AWS service logs to the corresponding <a href="https://docs.elastic.co/en/integrations" class="ulink" target="_top">integration data streams</a> for further processing and storage in the Elasticsearch cluster.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-automatic-routing"></a>Automatic routing<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>Elastic Serverless Forwarder supports automatic routing of the following logs to the corresponding default integration data stream:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
AWS CloudTrail (<code class="literal">aws.cloudtrail</code>)
</li>
<li class="listitem">
Amazon CloudWatch (<code class="literal">aws.cloudwatch_logs</code>)
</li>
<li class="listitem">
Elastic Load Balancing (<code class="literal">aws.elb_logs</code>)
</li>
<li class="listitem">
AWS Network Firewall (<code class="literal">aws.firewall_logs</code>)
</li>
<li class="listitem">
Amazon VPC Flow (<code class="literal">aws.vpcflow</code>)
</li>
<li class="listitem">
AWS Web Application Firewall (<code class="literal">aws.waf</code>)
</li>
</ul>
</div>
<p>For these use cases, setting the <code class="literal">es_datastream_name</code> field in the configuration file is optional.</p>
<p>For most other use cases, you will need to set the <code class="literal">es_datastream_name</code> field in the configuration file to route the data to a specific data stream or index. This value should be set in the following use cases:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
You want to write the data to a specific index, alias, or custom data stream, and not to the default integration data stream. This can help some users to use existing Elasticsearch assets like index templates, ingest pipelines, or dashboards, that are already set up and connected to business processes.
</li>
<li class="listitem">
When using <code class="literal">Kinesis Data Stream</code>, <code class="literal">CloudWatch Logs subscription filter</code> or <code class="literal">Direct SQS message payload</code> inputs. Only the <code class="literal">S3 SQS Event Notifications</code> input method supports automatic routing to default integration data streams for several AWS service logs.
</li>
<li class="listitem">
When using <code class="literal">S3 SQS Event Notifications</code> but where the log type is something <span class="strong strong"><strong>other than</strong></span> AWS CloudTrail (<code class="literal">aws.cloudtrail</code>), Amazon CloudWatch Logs (<code class="literal">aws.cloudwatch_logs</code>), Elastic Load Balancing (<code class="literal">aws.elb_logs</code>), AWS Network Firewall (<code class="literal">aws.firewall_logs</code>), Amazon VPC Flow (<code class="literal">aws.vpcflow</code>), and AWS Web Application Firewall (<code class="literal">aws.waf</code>).
</li>
</ul>
</div>
<p>If the <code class="literal">es_datastream_name</code> is not specified, and the log cannot be matched with any of the above AWS services, then the dataset will be set to <code class="literal">generic</code> and the namespace set to <code class="literal">default</code>, pointing to the data stream name <code class="literal">logs-generic-default</code>.</p>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-use-tags-filters"></a>Use tags and filters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>You can use tags and filters to tag and filter messages based on regular expressions.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-use-tags"></a>Use custom tags<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>You can add custom tags to filter and categorize items in events.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">inputs:
  - type: "s3-sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    tags:
      - "tag1"
      - "tag2"
      - "tag3"
    outputs:
      - type: "elasticsearch"
        args:
          elasticsearch_url: "arn:aws:secretsmanager:eu-central-1:123456789:secret:es_url"
          username: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:username"
          password: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:password"
          es_datastream_name: "logs-generic-default"</pre>
</div>
<p>Using the above example configuration, the tags will be set in the following way:</p>
<p><code class="literal">["forwarded", "generic", "tag1", "tag2", "tag3"]</code></p>
<p>The <code class="literal">forwarded</code> tag is always appended and the <code class="literal">generic</code> tag in this example comes from the dataset.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Tags must be defined within <code class="literal">inputs</code> in the <code class="literal">config.yaml</code> file.
</li>
<li class="listitem">
Each tag must be a string and added to the list.
</li>
</ul>
</div>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-define-include-exclude-filters"></a>Define include/exclude filters<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>You can define multiple filters for inputs to include or exclude events from data ingestion.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">inputs:
  - type: "s3-sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    include:
      - "[a-zA-Z]"
    exclude:
      - "skip this"
      - "skip also this"
    outputs:
      - type: "elasticsearch"
        args:
          elasticsearch_url: "arn:aws:secretsmanager:eu-central-1:123456789:secret:es_url"
          username: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:username"
          password: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:password"
          es_datastream_name: "logs-generic-default"</pre>
</div>
<p>You can define a list of regular expressions within <code class="literal">inputs.[].include</code>. If this list is populated, only messages <span class="strong strong"><strong>matching any</strong></span> of the defined regular expressions will be forwarded to the outputs.</p>
<p>You can define a list of regular expressions within <code class="literal">inputs.[].exclude</code>. If this list is populated, only messages <span class="strong strong"><strong>not matching any</strong></span> of the defined regular expressions will be forwarded to the outputs i.e. every message will be forwarded to the outputs unless it matches any of the defined regular expressions.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Both config parameters are optional, and can be set independently of each other. In terms of rule precedence, the exclude filter is applied first and then the include filter, so exclude takes precedence if both are specified.</p>
<p>All regular expressions are case-sensitive and should follow <a href="https://docs.python.org/3.9/library/re.html#regular-expression-syntax" class="ulink" target="_top">Python&#8217;s 3.9 regular expression syntax</a>.</p>
<p>Messages are scanned for terms that match the defined filters. Use the <code class="literal">^</code> (caret) special character to explicitly anchor the regex to the position before the first character of the string, and use <code class="literal">$</code> to anchor at the end.</p>
<p>No flags are used when the regular expression is compiled. Please refer to <a href="https://docs.python.org/3.9/library/re.html#re.compile" class="ulink" target="_top">inline flag documentation</a> for alternative options for multiline, case-insensitive, and other matching behaviors.</p>
</div>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-json-content"></a>JSON content discovery<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>The Elastic Serverless Forwarder is able to automatically discover JSON content in the payload of an input and collect the JSON objects contained in the payload.</p>
<p>The JSON objects can either be on a single line or spanning multiple lines. In the second case, the forwarder expects different JSON objects spanning multiple lines to be separated by a newline delimiter.</p>
<p>When JSON objects span multiple lines, a limit of 1000 lines is applied. Every JSON object spanning across more than 1000 lines will not be collected. Every line composing the whole JSON object will be forwarded individually instead.</p>
<p>If you have known payload content which includes single JSON objects that span more than 1000 lines, or if you find that relying on auto-discovery of JSON content has a big impact on performance, you can configure JSON content types within the inputs to address this. This will change the parsing logic and improve performance while overcoming the 1000 lines limit.</p>
<p>Where content is known to be plain text, you can improve overall performance by disabling automatic JSON content discovery completely.</p>
<p>To change this configuration option, set <code class="literal">inputs.[].json_content_type</code> to one of the following values:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>single</strong></span>: indicates that the content of a single item in the input payload is a single JSON object. The content can either be on a single line or spanning multiple lines. With this setting the whole content of the payload is decoded as a JSON object, with no limit on the number of lines the JSON object spans.
</li>
<li class="listitem">
<span class="strong strong"><strong>ndjson</strong></span>: indicates that the content of a single item in the input payload is a valid NDJSON format. Multiple single JSON objects formatted on a single line should be separated by a newline delimiter. With this setting each line will be decoded as JSON object, which improves the parsing performance.
</li>
<li class="listitem">
<span class="strong strong"><strong>disabled</strong></span>: instructs the forwarder not to attempt any automatic JSON content discovery and instead treat the content as plain text, which improves the parsing performance.
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>There is no need to configure the JSON content type when <a class="xref" href="aws-elastic-serverless-forwarder.html#expanding-events-from-json-object-lists" title="Expanding events from JSON object lists">Expanding events from JSON object lists</a>, unless you have single JSON objects that span more than 1000 lines.</p>
</div>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="expanding-events-from-json-object-lists"></a>Expanding events from JSON object lists<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>You can extract a list of events to be ingested from a specific field in the JSON file.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">inputs:
  - type: "s3-sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    expand_event_list_from_field: "Records"
    outputs:
      - type: "elasticsearch"
        args:
          elasticsearch_url: "arn:aws:secretsmanager:eu-central-1:123456789:secret:es_url"
          username: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:username"
          password: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:password"
          es_datastream_name: "logs-generic-default"</pre>
</div>
<p>You can define <code class="literal">inputs.[].expand_event_list_from_field</code> as a string with the value of a key in the JSON that contains a list of elements that must be sent as events instead of the encompassing JSON.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-route-service-logs" title="Route AWS service logs">routing service logs</a>, any value set for the <code class="literal">expand_event_list_from_field</code> configuration parameter will be ignored, because this will be automatically handled by the Elastic Serverless Forwarder.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_example"></a>Example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>With the following input:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{"Records":[{"key": "value #1"},{"key": "value #2"}]}
{"Records":[{"key": "value #3"},{"key": "value #4"}]}</pre>
</div>
<p>Without setting <code class="literal">expand_event_list_from_field</code>, two events will be forwarded:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{"@timestamp": "2022-06-16T04:06:03.064Z", "message": "{\"Records\":[{\"key\": \"value #1\"},{\"key\": \"value #2\"}]}"}
{"@timestamp": "2022-06-16T04:06:13.888Z", "message": "{\"Records\":[{\"key\": \"value #3\"},{\"key\": \"value #4\"}]}"}</pre>
</div>
<p>If <code class="literal">expand_event_list_from_field</code> is set to <code class="literal">Records</code>, four events will be forwarded:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{"@timestamp": "2022-06-16T04:06:21.105Z", "message": "{\"key\": \"value #1\"}"}
{"@timestamp": "2022-06-16T04:06:27.204Z", "message": "{\"key\": \"value #2\"}"}
{"@timestamp": "2022-06-16T04:06:31.154Z", "message": "{\"key\": \"value #3\"}"}
{"@timestamp": "2022-06-16T04:06:36.189Z", "message": "{\"key\": \"value #4\"}"}</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-manage-multiline-messages"></a>Manage multiline messages<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h4>
</div></div></div>
<p>Forwarded content may contain messages that span multiple lines of text. For example, multiline messages are common in files that contain Java stack traces. In order to correctly handle these multiline events, you need to configure <code class="literal">multiline</code> settings for a specific input to specify which lines are part of a single event.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-multiline-config"></a>Configuration options<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>You can specify the following options for a specific input in the <code class="literal">config.yaml</code> file to control how the Elastic Serverless Forwarder deals with messages that span multiple lines.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">inputs:
  - type: "s3-sqs"
    id: "arn:aws:sqs:%REGION%:%ACCOUNT%:%QUEUENAME%"
    multiline:
      type: pattern
      pattern: '^\\['
      negate: true
      match: after
    outputs:
      - type: "elasticsearch"
        args:
          elasticsearch_url: "arn:aws:secretsmanager:eu-central-1:123456789:secret:es_url"
          username: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:username"
          password: "arn:aws:secretsmanager:eu-west-1:123456789:secret:es_secrets:password"
          es_datastream_name: "logs-generic-default"</pre>
</div>
<p>The forwarder takes all the lines that do not start with <code class="literal">[</code> and combines them with the previous line that does. For example, you could use this configuration to join the following lines of a multiline message into a single event:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">[beat-logstash-some-name-832-2015.11.28] IndexNotFoundException[no such index]
    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver$WildcardExpressionResolver.resolve(IndexNameExpressionResolver.java:566)
    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver.concreteIndices(IndexNameExpressionResolver.java:133)
    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver.concreteIndices(IndexNameExpressionResolver.java:77)
    at org.elasticsearch.action.admin.indices.delete.TransportDeleteIndexAction.checkBlock(TransportDeleteIndexAction.java:75)</pre>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Note that you should escape the opening square bracket (<code class="literal">[</code>) in the regular expression, because it specifies a character class i.e. a set of characters that you wish to match. You also have to escape the backslash (<code class="literal">\</code>) used for escaping the opening square bracket as raw strings are not used. Thus, <code class="literal">^\\[</code> will produce the required regular expression upon compiling.</p>
</div>
</div>
<p><code class="literal">inputs.[].multiline.type</code> defines which aggregation method to use. The default is <code class="literal">pattern</code>. The other options are <code class="literal">count</code>, which enables you to aggregate a constant number of lines, and <code class="literal">while_pattern</code>, which aggregates lines by pattern without matching options.</p>
<p><code class="literal">inputs.[].multiline.pattern</code> differs from the patterns supported by Logstash. See <a href="https://docs.python.org/3.9/library/re.html#regular-expression-syntax" class="ulink" target="_top">Python&#8217;s 3.9 regular expression syntax</a> for a list of supported regexp patterns. Depending on how you configure other multiline options, lines that match the specified regular expression are considered either continuations of a previous line or the start of a new multiline event.</p>
<p><code class="literal">inputs.[].multiline.negate</code> defines whether the pattern is negated. The default is <code class="literal">false</code>. This setting works only with <code class="literal">pattern</code> and <code class="literal">while_pattern</code> types.</p>
<p><code class="literal">inputs.[].multiline.match</code> changes the grouping of multiple lines according to the schema below (works only with <code class="literal">pattern</code> type):</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Setting for <code class="literal">negate</code></p></td>
<td align="left" valign="top"><p>Setting for <code class="literal">match</code></p></td>
<td align="left" valign="top"><p>Result</p></td>
<td align="left" valign="top"><p>Example <code class="literal">pattern: ^b</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">false</code></p></td>
<td align="left" valign="top"><p><code class="literal">after</code></p></td>
<td align="left" valign="top"><p>Consecutive lines that match the pattern are appended to the previous line that doesn’t match.</p></td>
<td align="left" valign="top"><p><span class="image"><img src="images/false-after-multi.png" alt="Lines a b b c b b become &quot;abb&quot; and &quot;cbb&quot;"></span></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">false</code></p></td>
<td align="left" valign="top"><p><code class="literal">before</code></p></td>
<td align="left" valign="top"><p>Consecutive lines that match the pattern are prepended to the next line that doesn’t match.</p></td>
<td align="left" valign="top"><p><span class="image"><img src="images/false-after-multi.png" alt="Lines b b a b b c become &quot;bba&quot; and &quot;bbc&quot;"></span></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">true</code></p></td>
<td align="left" valign="top"><p><code class="literal">after</code></p></td>
<td align="left" valign="top"><p>Consecutive lines that don’t match the pattern are appended to the previous line that does match.</p></td>
<td align="left" valign="top"><p><span class="image"><img src="images/true-after-multi.png" alt="Lines b a c b d e become &quot;bac&quot; and &quot;bde&quot;"></span></p></td>
</tr>
<tr>
<td align="left" valign="top"><p><code class="literal">false</code></p></td>
<td align="left" valign="top"><p><code class="literal">before</code></p></td>
<td align="left" valign="top"><p>Consecutive lines that don’t match the pattern are prepended to the next line that does match.</p></td>
<td align="left" valign="top"><p><span class="image"><img src="images/true-before-multi.png" alt="Lines a c b d e b become &quot;acb&quot; and &quot;deb&quot;"></span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The <code class="literal">after</code> setting is equivalent to <code class="literal">previous</code> in <a href="https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html" class="ulink" target="_top">Logstash</a>, and <code class="literal">before</code> is equivalent to <code class="literal">next</code>.</p>
</div>
</div>
<p><code class="literal">inputs.[].multiline.flush_pattern</code> specifies a regular expression, in which the current multiline will be flushed from memory, ending the multiline-message. Works only with <code class="literal">pattern</code> type.</p>
<p><code class="literal">inputs.[].multiline.max_lines</code> defines the maximum number of lines that can be combined into one event. If the multiline message contains more than <code class="literal">max_lines</code>, any additional lines are truncated from the event. The default is <code class="literal">500</code>.</p>
<p><code class="literal">inputs.[].multiline.max_bytes</code> defines the maximum number of bytes that can be combined into one event. If the multiline message contains more than <code class="literal">max_bytes</code>, any additional content is truncated from the event. The default is <code class="literal">10485760</code>.</p>
<p><code class="literal">inputs.[].multiline.count_lines</code> defines the number of lines to aggregate into a single event. Works only with <code class="literal">count</code> type.</p>
<p><code class="literal">inputs.[].multiline.skip_newline</code> defined whether multiline events must be concatenated, stripping the line separator. If set to <code class="literal">true</code>, the line separator will be stripped. The default is <code class="literal">false</code>.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-multiline-config-examples"></a>Examples of multiline configuration<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>The examples in this section cover the following use cases:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Combining a Java stack trace into a single event
</li>
<li class="listitem">
Combining C-style line continuations into a single event
</li>
<li class="listitem">
Combining multiple lines from time-stamped events
</li>
</ul>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="aws-serverless-multiline-config-example-java"></a>Java stack traces<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h6>
</div></div></div>
<p>Java stack traces consist of multiple lines, with each line after the initial line beginning with whitespace, as in this example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">Exception in thread "main" java.lang.NullPointerException
        at com.example.myproject.Book.getTitle(Book.java:16)
        at com.example.myproject.Author.getBookTitles(Author.java:25)
        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)</pre>
</div>
<p>This configuration merges any line that begins with whitespace up to the previous line:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">multiline:
  type: pattern
  pattern: '^\s'
  negate: false
  match: after</pre>
</div>
<p>This is a slightly more complex Java stack trace example:</p>
<div class="pre_wrapper lang-java">
<pre class="programlisting prettyprint lang-java">Exception in thread "main" java.lang.IllegalStateException: A book has a null property
       at com.example.myproject.Author.getBookIds(Author.java:38)
       at com.example.myproject.Bootstrap.main(Bootstrap.java:14)
Caused by: java.lang.NullPointerException
       at com.example.myproject.Book.getId(Book.java:22)
       at com.example.myproject.Author.getBookIds(Author.java:35)
       ... 1 more</pre>
</div>
<p>To consolidate these lines into a single event, use the following multiline configuration:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">multiline:
  type: pattern
  pattern: '^\s+(at|.{3})\s+\\b|^Caused by:'
  negate: false
  match: after</pre>
</div>
<p>In this example, the pattern matches and merges the following lines:
-   a line that begins with spaces followed by the word <code class="literal">at</code> or <code class="literal">...</code>
-   a line that begins with the words <code class="literal">Caused by:</code></p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In Python’s string literals, <code class="literal">\b</code> is the backspace character (ASCII value 8). As raw strings are not used, Python would convert the <code class="literal">\b</code> to a backspace. In order for our regular expression to match as expected, you need to escape the backslash <code class="literal">\</code> in <code class="literal">\b</code> to <code class="literal">\\b</code>, which will produce the correct regular expression upon compiling.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="aws-serverless-multiline-line-continuations"></a>Line continuations<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h6>
</div></div></div>
<p>Several programming languages use the backslash (<code class="literal">\</code>) character at the end of a line to denote that the line continues, as in this example:</p>
<div class="pre_wrapper lang-c">
<pre class="programlisting prettyprint lang-c">printf ("%10.10ld  \t %10.10ld \t %s\
  %f", w, x, y, z );</pre>
</div>
<p>To consolidate these lines into a single event, use the following multiline configuration:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">multiline:
  type: pattern
  pattern: '\\\\$'
  negate: false
  match: after</pre>
</div>
<p>This configuration merges any line that ends with the <code class="literal">\</code> character with the line that follows it.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Note that you should escape the opening backslash (<code class="literal">\</code>) twice in the regular expression, as raw strings are not used. Thus, <code class="literal">\\\\$</code> will produce the required regular expression upon compiling.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="aws-serverless-multiline-timestamps"></a>Timestamps<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h6>
</div></div></div>
<p>Activity logs from services such as Elasticsearch typically begin with a timestamp, followed by information on the specific activity, as in this example:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">[2015-08-24 11:49:14,389][INFO ][env                      ] [Letha] using [1] data paths, mounts [[/
(/dev/disk1)]], net usable_space [34.5gb], net total_space [118.9gb], types [hfs]</pre>
</div>
<p>To consolidate these lines into a single event, use the following multiline configuration:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">multiline:
  type: pattern
  pattern: '^\\[[0-9]{4}-[0-9]{2}-[0-9]{2}'
  negate: true
  match: after</pre>
</div>
<p>This configuration uses the <code class="literal">negate: true</code> and <code class="literal">match: after</code> settings to specify that any line that does not match the specified pattern belongs to the previous line.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Note that you should escape the opening square bracket (<code class="literal">[</code>) in the regular expression, because it specifies a character class i.e. a set of characters that you wish to match. You also have to escape the backslash (<code class="literal">\</code>) used for escaping the opening square bracket as raw strings are not used. Thus, <code class="literal">^\\[</code> will produce the required regular expression upon compiling.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h6 class="title"><a id="aws-serverless-multiline-application-events"></a>Application events<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h6>
</div></div></div>
<p>Sometimes your application logs contain events, that begin and end with custom markers, such as the following example:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">[2015-08-24 11:49:14,389] Start new event
[2015-08-24 11:49:14,395] Content of processing something
[2015-08-24 11:49:14,399] End event</pre>
</div>
<p>To consolidate these lines into a single event, use the following multiline configuration:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">multiline:
  type: pattern
  pattern: 'Start new event'
  negate: true
  match: after
  flush_pattern: 'End event'</pre>
</div>
<p>The <code class="literal">flush_pattern</code> option specifies a regex at which the current multiline will be flushed. If you think of the <code class="literal">pattern</code> option specifying the beginning of an event, the <code class="literal">flush_pattern</code> option will specify the end or last line of the event.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This example will not work correctly if start/end log blocks are mixed with non-multiline logs, or if different start/end log blocks overlap with each other. For instance, <code class="literal">Some other log</code> log lines in the following example will be merged into a <span class="strong strong"><strong>single</strong></span> multiline document because they neither match <code class="literal">inputs.[].multiline.pattern</code> nor <code class="literal">inputs.[].multiline.flush_pattern</code>, and <code class="literal">inputs.[].multiline.negate</code> is set to <code class="literal">true</code>.</p>
</div>
</div>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">[2015-08-24 11:49:14,389] Start new event
[2015-08-24 11:49:14,395] Content of processing something
[2015-08-24 11:49:14,399] End event
[2015-08-24 11:50:14,389] Some other log
[2015-08-24 11:50:14,395] Some other log
[2015-08-24 11:50:14,399] Some other log
[2015-08-24 11:51:14,389] Start new event
[2015-08-24 11:51:14,395] Content of processing something
[2015-08-24 11:51:14,399] End event</pre>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="aws-serverless-multiline-test-regexp"></a>Test your regexp pattern for multiline<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-elastic-serverless-forwarder-configuration.asciidoc">edit</a></h5>
</div></div></div>
<p>To make it easier for you to test the regexp patterns in your multiline config, you can use this <a href="https://replit.com/@AndreaSpacca/Multiline-Regexp-Test#main.py" class="ulink" target="_top">Multiline Regexp Test</a>:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Plug in the regexp pattern at line <code class="literal">3</code>, along with the <code class="literal">multiline.negate</code> setting that you plan to use at line <code class="literal">4</code>
</li>
<li class="listitem">
Paste a sample message between the three double quote delimiters (<code class="literal">""" """</code>) at line <code class="literal">5</code>
</li>
<li class="listitem">
Click <code class="literal">Run</code> to see which lines in the message match your specified configuration.
</li>
</ol>
</div>
<p class="screenshot"><span class="image"><img src="images/multiline-regexp-test-repl-main.png" alt="Add your test message to Multiline Regexp test"></span></p>
<p class="screenshot"><span class="image"><img src="images/multiline-regexp-test-repl-run.png" alt="View the test results"></span></p>
</div>

</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="aws-serverless-troubleshooting"></a>Troubleshooting and error handling<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-serverless-troubleshooting.asciidoc">edit</a></h3>
</div></div></div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_troubleshooting_deployment_errors"></a>Troubleshooting deployment errors<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-serverless-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>You can view the status of deployment actions and get additional information on events, including why a particular event fails e.g. misconfiguration details.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
On the Applications page for <span class="strong strong"><strong>serverlessrepo-elastic-serverless-forwarder</strong></span>, click <span class="strong strong"><strong>Deployments</strong></span>.
</li>
<li class="listitem">
You can view the <span class="strong strong"><strong>Deployment history</strong></span> here and refresh the page for updates as the application deploys. It should take around 5 minutes to deploy &mdash; if the deployment fails for any reason, the create events will be rolled back and you will be able to see an explanation for which event failed.
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>For example, if you don&#8217;t increase the visibility timeout for an SQS queue as described in <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs-s3" title="Amazon S3 (via SQS event notifications)">Amazon S3 (via SQS event notifications)</a>, you will see a <code class="literal">CREATE_FAILED</code><span class="strong strong"><strong>Status</strong></span> for the event, and the <span class="strong strong"><strong>Status reason</strong></span> provides additional detail.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-troubleshooting-vpc-prerequisites"></a>Prerequisites when attached to a VPC<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-serverless-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>If the Elastic Serverless Forwarder is attached to a VPC, you need to <a href="https://docs.aws.amazon.com/vpc/latest/privatelink/create-interface-endpoint.html" class="ulink" target="_top">create VPC Endpoints</a> for S3 and SQS, and for <span class="strong strong"><strong>every</strong></span> service you define as an input for the forwarder. S3 and SQS VPC Endpoints are always required for reading the <code class="literal">config.yaml</code> uploaded to S3 and managing the <em>Continuing queue</em> and the <em>Replay queue</em>, regardless of the <a class="xref" href="aws-elastic-serverless-forwarder.html#aws-serverless-forwarder-inputs" title="Inputs">Inputs</a> used.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_preventing_unexpected_costs"></a>Preventing unexpected costs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-serverless-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>It is important to monitor the Elastic Serverless Forwarder Lambda function for timeouts to prevent unexpected costs. You can use the <a href="https://docs.elastic.co/en/integrations/aws/lambda" class="ulink" target="_top">AWS Lambda integration</a> for this. If the timeouts are constant, you should throttle the Lambda function to stop its execution before proceeding with any troubleshooting steps. In most cases, constant timeouts will cause the records and messages from the event triggers to go back to their sources and trigger the function again, which will cause further timeouts and force a loop that will incure unexpected high costs. For more information on throttling Lambda functions, refer to <a href="https://docs.aws.amazon.com/lambda/latest/operatorguide/throttling.html" class="ulink" target="_top">AWS docs</a>.</p>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_increase_debug_information"></a>Increase debug information<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-serverless-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>To help with debugging, you can increase the amount of logging detail by adding an environment variable as follows:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Select the serverless forwarder <span class="strong strong"><strong>application</strong></span> from <span class="strong strong"><strong>Lambda &gt; Functions</strong></span>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Configuration</strong></span> and select <span class="strong strong"><strong>Environment Variables</strong></span> and choose <span class="strong strong"><strong>Edit</strong></span>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add environment variable</strong></span> and enter <code class="literal">LOG_LEVEL</code> as <span class="strong strong"><strong>Key</strong></span> and <code class="literal">DEBUG</code> as <span class="strong strong"><strong>Value</strong></span> and click <span class="strong strong"><strong>Save</strong></span>
</li>
</ol>
</div>
</div>

</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="aws-serverless-troubleshooting-event-id-format"></a>Using the Event ID format (version 1.6.0 and above)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-serverless-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>Version 1.6.0 introduces a new event ID format that prevents duplicate ID errors when a high volume of events is ingested to Elasticsearch. This new format combines a timestamp with data specific to the relevant AWS resource, extracted from the AWS Lambda event received by the forwarder.</p>
<p>The timestamp is used as a prefix for the ID, because identifiers that gradually increase over time generally result in better indexing performance in Elasticsearch, based on sorting order rather than completely random identifiers. For more information, please refer to <a href="https://www.elastic.co/blog/efficient-duplicate-prevention-for-event-based-data-in-elasticsearch" class="ulink" target="_top">this Elastic blog on event-based data</a>.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If old events that are already published to Elasticsearch using a version of Elastic Serverless Forwarder before v1.6.0 are ingested again, they will be treated as new events and published to Elasticsearch as duplicates.</p>
</div>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="_error_handling"></a>Error handling<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-serverless-troubleshooting.asciidoc">edit</a></h4>
</div></div></div>
<p>There are two kind of errors that can occur during execution of the forwarder:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Errors <em>before</em> the ingestion phase begins
</li>
<li class="listitem">
Errors <em>during</em> the ingestion phase
</li>
</ol>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_errors_before_ingestion"></a>Errors before ingestion<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-serverless-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>For errors that occur before ingestion begins (1), the function will return a failure. These errors are mostly due to misconfiguration, incorrect permissions for AWS resources, etc. Most importantly, when an error occurs at this stage we don’t have any status for events that are ingested, so there’s no requirement to keep data, and the function can fail safely. In the case of SQS messages and Kinesis data stream records, both will go back into the queue and trigger the function again with the same payload.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_errors_during_ingestion"></a>Errors during ingestion<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-serverless-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>For errors that occur during ingestion (2), the situation is different. We do have a status for <span class="strong strong"><strong>N</strong></span> failed events out of <span class="strong strong"><strong>X</strong></span> total events; if we fail the whole function then all <span class="strong strong"><strong>X</strong></span> events will be processed again. While the <span class="strong strong"><strong>N</strong></span> failed ones could potentially succeed, the remaining <span class="strong strong"><strong>X-N</strong></span> will definitely fail, because the data streams are append-only (the function would attempt to recreate already ingested documents using the same document ID).</p>
<p>So the forwarder won&#8217;t return a failure for errors during ingestion; instead, the payload of the event that failed to be ingested will be sent to a replay SQS queue, which is automatically set up during the deployment. The replay SQS queue is not set as an Event Source Mapping for the function by default, which means you can investigate and consume (or not) the message as preferred.</p>
<p>You can temporarily set the replay SQS queue as an Event Source Mapping for the forwarder, which means messages in the queue will be consumed by the function and ingestion retried for transient failures. If the failure persists, the affected log entry will be moved to a DLQ after three retries.</p>
<p>Every other error that occurs during the execution of the forwarder is silently ignored, and reported to the APM server if instrumentation is enabled.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h5 class="title"><a id="_execution_timeout"></a>Execution timeout<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/observability/aws-serverless-troubleshooting.asciidoc">edit</a></h5>
</div></div></div>
<p>There is a grace period of 2 minutes before the timeout of the Lambda function where no more ingestion will occur. Instead, during this grace period the forwarder will collect and handle any unprocessed payloads in the batch of the input used as trigger.</p>
<p>For CloudWatch Logs event, Kinesis data stream, S3 SQS Event Notifications and direct SQS message payload inputs, the unprocessed batch will be sent to the SQS continuing queue.</p>
</div>

</div>

</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="deploy-beats-to-send-data.html">« Deploy Beats to send data</a>
</span>
<span class="next">
<a href="aws-firehose.html">Amazon Kinesis Data Firehose »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
